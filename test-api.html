<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Testing - Lunch Roulette</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .secondary { background: #6c757d; color: white; }
        .danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Lunch Roulette API Testing Suite</h1>
    
    <div class="test-section">
        <h2>åŸºç¡€APIçŠ¶æ€æµ‹è¯•</h2>
        <button class="primary" onclick="testAPIStatus()">æµ‹è¯•APIçŠ¶æ€</button>
        <button class="secondary" onclick="testCacheSystem()">æµ‹è¯•ç¼“å­˜ç³»ç»Ÿ</button>
        <button class="secondary" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        <div id="basicTests"></div>
    </div>

    <div class="test-section">
        <h2>é¤å…æ•°æ®è·å–æµ‹è¯•</h2>
        <button class="primary" onclick="testRestaurantAPI()">æµ‹è¯•é¤å…API</button>
        <button class="secondary" onclick="testFallbackData()">æµ‹è¯•å¤‡ç”¨æ•°æ®</button>
        <div id="restaurantTests"></div>
    </div>

    <div class="test-section">
        <h2>æ€§èƒ½ç›‘æ§æµ‹è¯•</h2>
        <button class="primary" onclick="testPerformanceMonitoring()">æµ‹è¯•æ€§èƒ½ç›‘æ§</button>
        <button class="secondary" onclick="showAPIReport()">æ˜¾ç¤ºAPIæŠ¥å‘Š</button>
        <div id="performanceTests"></div>
    </div>

    <div class="test-section">
        <h2>APIç®¡ç†åŠŸèƒ½æµ‹è¯•</h2>
        <button class="primary" onclick="testAPIManagement()">æµ‹è¯•APIç®¡ç†</button>
        <button class="danger" onclick="resetAllTests()">é‡ç½®æ‰€æœ‰æµ‹è¯•</button>
        <div id="managementTests"></div>
    </div>

    <script src="script.js"></script>
    <script>
        // Test Functions
        function addTestResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            container.appendChild(result);
            container.scrollTop = container.scrollHeight;
        }

        async function testAPIStatus() {
            addTestResult('basicTests', 'å¼€å§‹æµ‹è¯•APIçŠ¶æ€...', 'info');
            
            try {
                const stats = restaurantAPI.getUsageStats();
                addTestResult('basicTests', `å‘ç° ${Object.keys(stats).length} ä¸ªAPIé…ç½®`, 'success');
                
                Object.entries(stats).forEach(([name, api]) => {
                    const status = api.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                    const health = api.healthStatus || 'æœªçŸ¥';
                    addTestResult('basicTests', `${name}: ${status}, å¥åº·çŠ¶æ€: ${health}, ä½¿ç”¨é‡: ${api.used}/${api.limit}`, 'info');
                });

                // Test health check
                const report = restaurantAPI.getStatusReport();
                addTestResult('basicTests', `æ€§èƒ½æŠ¥å‘Šç”ŸæˆæˆåŠŸ - æ€»è¯·æ±‚: ${report.performance.totalRequests}`, 'success');
                
            } catch (error) {
                addTestResult('basicTests', `APIçŠ¶æ€æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCacheSystem() {
            addTestResult('basicTests', 'å¼€å§‹æµ‹è¯•ç¼“å­˜ç³»ç»Ÿ...', 'info');
            
            try {
                // Clear cache first
                restaurantAPI.cache.clear();
                restaurantAPI.shortCache.clear();
                addTestResult('basicTests', 'ç¼“å­˜å·²æ¸…ç©º', 'info');

                // Test cache key generation
                const cacheKey = restaurantAPI.getCacheKey('Pizza', 'Sydney');
                addTestResult('basicTests', `ç¼“å­˜é”®ç”Ÿæˆæµ‹è¯•: ${cacheKey}`, 'success');

                // Test cache storage
                restaurantAPI.setCachedData(cacheKey, [{ name: 'Test Restaurant', rating: '4.5' }]);
                addTestResult('basicTests', 'æµ‹è¯•æ•°æ®å·²å­˜å‚¨åˆ°ç¼“å­˜', 'success');

                // Test cache retrieval
                const cached = restaurantAPI.getCachedData(cacheKey);
                if (cached) {
                    addTestResult('basicTests', `ç¼“å­˜æ£€ç´¢æˆåŠŸ: ${cached.data.length} æ¡è®°å½•`, 'success');
                } else {
                    addTestResult('basicTests', 'ç¼“å­˜æ£€ç´¢å¤±è´¥', 'error');
                }

            } catch (error) {
                addTestResult('basicTests', `ç¼“å­˜ç³»ç»Ÿæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testErrorHandling() {
            addTestResult('basicTests', 'å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†...', 'info');
            
            try {
                // Test circuit breaker
                const failAPI = 'testFail';
                addTestResult('basicTests', 'æµ‹è¯•ç†”æ–­å™¨æœºåˆ¶...', 'info');

                // Test API failure handling
                restaurantAPI.handleAPIFailure('yelp', new Error('Test error'));
                addTestResult('basicTests', 'APIå¤±è´¥å¤„ç†æµ‹è¯•å®Œæˆ', 'success');

                // Test retry mechanism
                addTestResult('basicTests', 'é‡è¯•æœºåˆ¶å·²é›†æˆåˆ°APIè°ƒç”¨ä¸­', 'info');

            } catch (error) {
                addTestResult('basicTests', `é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testRestaurantAPI() {
            addTestResult('restaurantTests', 'å¼€å§‹æµ‹è¯•é¤å…API...', 'info');
            
            try {
                const testCases = [
                    { dish: 'Pizza', category: 'Italian', city: 'sydney' },
                    { dish: 'Sushi', category: 'Japanese', city: 'melbourne' },
                    { dish: 'Burger', category: 'American', city: 'brisbane' }
                ];

                for (const testCase of testCases) {
                    addTestResult('restaurantTests', `æµ‹è¯• ${testCase.dish} åœ¨ ${testCase.city}...`, 'info');
                    
                    const startTime = Date.now();
                    const result = await restaurantAPI.getRestaurantData(testCase.dish, testCase.category, testCase.city);
                    const duration = Date.now() - startTime;
                    
                    if (result.success) {
                        addTestResult('restaurantTests', 
                            `âœ… ${testCase.dish}: ${result.data.length} å®¶é¤å…, æ•°æ®æº: ${result.source}, è€—æ—¶: ${duration}ms`, 
                            'success');
                    } else {
                        addTestResult('restaurantTests', `âŒ ${testCase.dish}: è·å–å¤±è´¥`, 'error');
                    }
                }

            } catch (error) {
                addTestResult('restaurantTests', `é¤å…APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFallbackData() {
            addTestResult('restaurantTests', 'å¼€å§‹æµ‹è¯•å¤‡ç”¨æ•°æ®...', 'info');
            
            try {
                const fallbackData = restaurantAPI.getFallbackData('Pizza', 'Italian', 'sydney');
                if (fallbackData && fallbackData.length > 0) {
                    addTestResult('restaurantTests', `å¤‡ç”¨æ•°æ®æµ‹è¯•æˆåŠŸ: ${fallbackData.length} å®¶é¤å…`, 'success');
                    
                    // Show sample restaurant
                    const sample = fallbackData[0];
                    addTestResult('restaurantTests', 
                        `ç¤ºä¾‹é¤å…: ${sample.name} - è¯„åˆ†: ${sample.rating} - ${sample.specialty}`, 
                        'info');
                } else {
                    addTestResult('restaurantTests', 'å¤‡ç”¨æ•°æ®ä¸ºç©º', 'error');
                }

            } catch (error) {
                addTestResult('restaurantTests', `å¤‡ç”¨æ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPerformanceMonitoring() {
            addTestResult('performanceTests', 'å¼€å§‹æµ‹è¯•æ€§èƒ½ç›‘æ§...', 'info');
            
            try {
                const report = restaurantAPI.getPerformanceReport();
                addTestResult('performanceTests', 
                    `æ€§èƒ½æŠ¥å‘Š: æˆåŠŸç‡ ${report.successRate}, ç¼“å­˜å‘½ä¸­ç‡ ${report.cacheHitRate}, å¹³å‡å“åº”æ—¶é—´ ${report.averageResponseTime}`, 
                    'success');

                // Test metrics update
                restaurantAPI.updateMetrics('test', 100, true);
                addTestResult('performanceTests', 'æŒ‡æ ‡æ›´æ–°æµ‹è¯•å®Œæˆ', 'success');

                // Show cache info
                addTestResult('performanceTests', 
                    `ç¼“å­˜çŠ¶æ€: ä¸»ç¼“å­˜ ${report.cacheSize} æ¡, çŸ­ç¼“å­˜ ${report.shortCacheSize} æ¡`, 
                    'info');

            } catch (error) {
                addTestResult('performanceTests', `æ€§èƒ½ç›‘æ§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showAPIReport() {
            addTestResult('performanceTests', 'æ˜¾ç¤ºå®Œæ•´APIæŠ¥å‘Š...', 'info');
            showAPIUsage();
        }

        async function testAPIManagement() {
            addTestResult('managementTests', 'å¼€å§‹æµ‹è¯•APIç®¡ç†åŠŸèƒ½...', 'info');
            
            try {
                // Test API toggle
                restaurantAPI.toggleAPI('yelp', false);
                addTestResult('managementTests', 'Yelp APIå·²ç¦ç”¨', 'success');
                
                restaurantAPI.toggleAPI('yelp', true);
                addTestResult('managementTests', 'Yelp APIå·²é‡æ–°å¯ç”¨', 'success');

                // Test usage reset
                const originalUsage = restaurantAPI.apis.yelp.used;
                restaurantAPI.resetAPIUsage('yelp');
                addTestResult('managementTests', `Yelp APIä½¿ç”¨é‡é‡ç½®: ${originalUsage} â†’ 0`, 'success');

                // Test comprehensive report
                const statusReport = restaurantAPI.getStatusReport();
                addTestResult('managementTests', 
                    `çŠ¶æ€æŠ¥å‘Šç”ŸæˆæˆåŠŸ: ${Object.keys(statusReport.apis).length} ä¸ªAPI, æŠ¥å‘Šæ—¶é—´: ${statusReport.timestamp}`, 
                    'success');

            } catch (error) {
                addTestResult('managementTests', `APIç®¡ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function resetAllTests() {
            document.getElementById('basicTests').innerHTML = '';
            document.getElementById('restaurantTests').innerHTML = '';
            document.getElementById('performanceTests').innerHTML = '';
            document.getElementById('managementTests').innerHTML = '';
            
            // Reset API system
            restaurantAPI.resetAPIUsage();
            restaurantAPI.cache.clear();
            restaurantAPI.shortCache.clear();
            
            addTestResult('managementTests', 'æ‰€æœ‰æµ‹è¯•å·²é‡ç½®ï¼ŒAPIç³»ç»Ÿå·²æ¸…ç©º', 'info');
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('basicTests', 'é¡µé¢åŠ è½½å®Œæˆï¼ŒAPIç³»ç»Ÿå·²åˆå§‹åŒ–', 'success');
                addTestResult('basicTests', 'æç¤º: ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯åŠŸèƒ½', 'info');
            }, 1000);
        });

        // Console helpers
        window.testHelpers = {
            runAllTests: async () => {
                await testAPIStatus();
                await testCacheSystem();
                await testRestaurantAPI();
                await testPerformanceMonitoring();
                await testAPIManagement();
            },
            getReport: () => restaurantAPI.getStatusReport(),
            showDebugAPI: () => console.log(window.restaurantAPIDebug)
        };
    </script>
</body>
</html>